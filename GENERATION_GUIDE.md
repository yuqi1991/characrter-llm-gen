# 🚀 语料生成功能使用指南

## 功能概述

本版本新增了完整的语料生成功能，支持：

- ✅ **结构化输出**：使用 OpenAI Structured Output API 确保 JSON 格式正确
- ✅ **并行处理**：支持多个请求并行处理，提高生成效率
- ✅ **实时预览**：生成完成后立即预览结果
- ✅ **批量入库**：一键将生成结果保存到数据库
- ✅ **JSON导出**：支持导出生成结果为 JSON 文件

## 使用流程

### 1. 准备工作

在开始生成之前，请确保已完成：

1. **创建角色卡**：在"角色卡管理"页面创建至少一个角色
2. **设置场景标签**：在"场景标签管理"页面创建场景
3. **配置数据集**：在"语料数据集管理"页面创建数据集并绑定角色和场景
4. **配置API**：在"语料生成"页面配置 OpenAI API 密钥

### 2. 生成语料

#### 步骤1：选择数据集
- 在"选择数据集"下拉框中选择要生成语料的目标数据集
- 系统会自动加载该数据集绑定的角色和场景信息

#### 步骤2：配置生成参数
- **总生成数量**：设置要生成的对话总数（1-1000）
- **每条语料对话轮数**：设置每个对话的轮次数（1-20）
- **并行请求数**：设置同时发送的请求数（1-20），提高生成效率

#### 步骤3：配置API调用
- **选择API配置**：从已保存的配置中选择
- **选择模型**：点击"获取可用模型"按钮自动获取模型列表
- **调整参数**：设置温度、最大长度等生成参数

#### 步骤4：预览提示词
- 点击"生成/刷新提示词"按钮预览最终发送给 LLM 的提示词
- 确认提示词内容符合预期

#### 步骤5：开始生成
- 点击"🚀 开始生成"按钮启动生成过程
- 在"生成状态"区域查看进度信息
- 生成完成后在"生成结果预览"中查看前10条结果

### 3. 结果处理

#### 预览结果
- 生成完成后，结果会显示在预览表格中
- 包含序号、场景标签、对话内容、轮数等信息
- 默认只显示前10条，但实际生成的所有对话都会保存

#### 确认入库
- 点击"💾 确认入库"按钮将生成结果保存到数据库
- 保存后可在"语料数据集管理"页面查看完整语料

#### 导出JSON
- 点击"📄 导出JSON"按钮导出完整的生成结果
- 导出文件包含批次信息和所有对话数据

## 技术特性

### 结构化输出
- 使用 OpenAI Beta API 的 `chat.completions.parse` 功能
- 通过 Pydantic 模型确保输出格式严格符合要求
- 自动处理 JSON 解析错误和格式问题

### 并行处理
- 支持将大量生成任务分割为多个并行请求
- 使用 asyncio 和 aiohttp 实现高效异步处理
- 自动计算每个批次的任务分配

### 数据持久化
- 生成结果自动关联到正确的数据集和场景
- 支持批量保存，事务安全
- 保留生成时间、批次ID等元数据

## API支持

### 当前支持
- **OpenAI API**：完全支持，包括结构化输出
- **Google AI API**：基础支持，JSON解析
- **Anthropic API**：基础支持（未来版本）

### 推荐配置
对于最佳体验，推荐使用：
- **模型**：gpt-4o-mini 或 gpt-4o（支持结构化输出）
- **温度**：0.7-0.9（对话自然度）
- **并行请求数**：3-5（平衡速度和稳定性）

## 故障排除

### 常见问题

1. **"请确保已选择数据集、API配置和模型"**
   - 检查所有必需字段是否已填写
   - 确认API配置中的密钥是否正确

2. **"数据集未绑定任何角色"**
   - 在数据集管理页面为数据集绑定角色

3. **"获取模型列表失败"**
   - 检查API密钥是否正确
   - 检查网络连接
   - 检查Base URL设置（如使用代理）

4. **生成结果为空**
   - 检查API余额是否充足
   - 尝试降低并行请求数
   - 检查模型是否支持所需功能

### 性能优化

1. **提高生成速度**
   - 增加并行请求数（建议不超过10）
   - 使用更快的模型（如 gpt-4o-mini）
   - 减少每条对话的轮数

2. **提高生成质量**
   - 完善角色卡的人格描述
   - 细化场景标签的描述
   - 提供更多对话示例

3. **节省成本**
   - 使用较小的模型
   - 降低最大token数
   - 分批次生成而非一次性大量生成

## 示例结果格式

生成的对话会按照以下 JSON 格式保存：

```json
{
  "scenario_labels": ["日常对话", "情感交流"],
  "dialogues": [
    {
      "role": "user",
      "content": "你今天过得怎么样？"
    },
    {
      "role": "assistant", 
      "content": "今天过得很不错呢！早上去公园跑了步..."
    }
  ],
  "turn_count": 3,
  "batch_id": "batch_20241201_143022",
  "generation_time": "2024-12-01T14:30:22"
}
```

## 更新日志

### v1.0.0 (2024-12-01)
- ✅ 新增结构化输出支持
- ✅ 新增并行处理功能
- ✅ 新增实时结果预览
- ✅ 新增批量入库功能
- ✅ 新增JSON导出功能
- ✅ 完善错误处理和用户反馈

---

💡 **提示**：建议先用较小的数量（如2-5条）测试生成效果，确认配置正确后再进行大批量生成。 